<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nozzle â†’ Bead Calculator</title>

  <style>
    /* =========================================================
       THEME SYSTEM (manual light/dark toggle)
       - default = dark
       - add/remove: <html data-theme="light">
       ========================================================= */
    :root{
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

      /* shared */
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --accent:#1f6b5d;
      --accent2:#2a9d8f;
      --focus: rgba(42,157,143,.25);

      /* DARK (default) */
      --bg: #0b0f10;
      --panel: #11191b;
      --panel2:#0f1517;
      --text:#e7f1f2;
      --muted:#a9c0c3;
      --line: rgba(255,255,255,.10);
      --fieldBg: rgba(255,255,255,.06);
      --fieldBg2: rgba(255,255,255,.04);
      --fieldText: var(--text);
      --fieldBorder: rgba(255,255,255,.10);
      --optionBg: #0e1517;
      --optionText: #e7f1f2;
      --segBg: rgba(255,255,255,.06);
    }

    html[data-theme="light"]{
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --bg:#f3f7f7;
      --panel:#ffffff;
      --panel2:#f7fbfb;
      --text:#0a1416;
      --muted:#4d6a6f;
      --line: rgba(0,0,0,.10);
      --fieldBg: rgba(0,0,0,.03);
      --fieldBg2: rgba(0,0,0,.025);
      --fieldText: var(--text);
      --fieldBorder: rgba(0,0,0,.12);
      --optionBg: #ffffff;
      --optionText: #0a1416;
      --segBg: rgba(0,0,0,.03);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -20%, rgba(42,157,143,.18), transparent 55%),
        radial-gradient(900px 500px at 100% 0%, rgba(31,107,93,.18), transparent 50%),
        var(--bg);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title h1{
      margin:0;
      font-size: clamp(18px, 2.6vw, 26px);
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-size: 14px;
      line-height:1.35;
    }

    .rightHead{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      box-shadow: var(--shadow);
    }
    html[data-theme="light"] .badge{ background: rgba(0,0,0,.03); }

    .themeBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      box-shadow: var(--shadow);
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    html[data-theme="light"] .themeBtn{ background: rgba(0,0,0,.03); }
    .themeBtn:hover{
      border-color: rgba(42,157,143,.55);
      background: rgba(42,157,143,.12);
    }
    .themeBtn:active{ transform: translateY(1px); }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
      .badge{ display:none; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent 40%), var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    html[data-theme="light"] .card{ background: var(--panel); }

    .card .head{
      padding: 14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: var(--panel2);
    }

    .card .head h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.3px;
      text-transform:uppercase;
      color: var(--muted);
      font-weight: 700;
    }

    .card .body{ padding: 14px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 480px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }

    /* ---------- Segmented input mode switch ---------- */
    .seg{
      display:flex;
      border:1px solid var(--line);
      background: var(--segBg);
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      margin-bottom: 12px;
    }
    .seg button{
      flex:1;
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 13px;
      font-weight: 700;
      letter-spacing:.2px;
      transition: background .2s ease, color .2s ease;
    }
    .seg button.active{
      background: rgba(42,157,143,.18);
      color: var(--text);
      outline: 1px solid rgba(42,157,143,.35);
    }

    /* ---------- Inputs (select readability fixed for embeds) ---------- */
    select, input[type="number"], input[type="text"]{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--fieldBorder);
      background: var(--fieldBg);
      color: var(--fieldText);
      outline:none;
      font-size: 14px;
      appearance: none;
    }

    select{
      padding-right: 42px;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) calc(1em + 1px),
        calc(100% - 13px) calc(1em + 1px),
        calc(100% - 2.5em) 0.5em;
      background-size:
        5px 5px,
        5px 5px,
        1px 1.5em;
      background-repeat: no-repeat;
    }

    select option{
      background: var(--optionBg);
      color: var(--optionText);
    }

    select:focus, input:focus{
      border-color: rgba(42,157,143,.55);
      box-shadow: 0 0 0 3px var(--focus);
    }

    .sliderWrap{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--fieldBg2);
    }

    input[type="range"]{
      width:100%;
      accent-color: var(--accent2);
    }

    .ticks{
      display:flex;
      justify-content:space-between;
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
      opacity:.9;
      gap: 6px;
    }
    .ticks span{ white-space:nowrap; }

    .toggleLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--line);
    }

    .switch{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      cursor:pointer;
      color: var(--muted);
      font-size: 13px;
    }
    .switch input{ display:none; }

    .pill{
      width:44px;height:26px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      position:relative;
      transition: all .2s ease;
    }
    html[data-theme="light"] .pill{ background: rgba(0,0,0,.05); }

    .dot{
      width:20px;height:20px;border-radius:999px;
      background: rgba(255,255,255,.75);
      position:absolute; top:2px; left:2px;
      transition: all .2s ease;
    }
    .switch input:checked + .pill{
      background: rgba(42,157,143,.22);
      border-color: rgba(42,157,143,.55);
    }
    .switch input:checked + .pill .dot{
      left:22px;
      background: rgba(42,157,143,.95);
    }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; }

    button.std{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    html[data-theme="light"] button.std{ background: rgba(0,0,0,.03); }
    button.std:hover{ border-color: rgba(42,157,143,.55); background: rgba(42,157,143,.12); }
    button.std:active{ transform: translateY(1px); }
    .primary{
      border-color: rgba(42,157,143,.45) !important;
      background: rgba(42,157,143,.18) !important;
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: var(--fieldBg2);
    }
    .kpi .lab{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kpi .val{
      font-family: var(--mono);
      font-size: 20px;
      letter-spacing:.2px;
    }
    .kpi .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .note{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--fieldBg2);
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
    }
    .note strong{ color: var(--text); }

    .viz{
      margin-top: 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: var(--fieldBg2);
    }
    .vizTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
    }

    .stage{
      height: 160px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 8px;
    }
    .bed{
      width: 92%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      position:relative;
    }
    html[data-theme="light"] .bed{ background: rgba(0,0,0,.10); }

    .bead{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom: 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(42,157,143,.85), rgba(31,107,93,.45));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 30px rgba(0,0,0,.18);
      transition: width .18s ease, height .18s ease;
    }
    html[data-theme="light"] .bead{
      border-color: rgba(0,0,0,.10);
      box-shadow: 0 14px 25px rgba(0,0,0,.12);
    }

    .dim{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
    }

    details{
      border-top: 1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    html[data-theme="light"] details{ background: rgba(0,0,0,.01); }

    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-weight:700;
      text-transform:uppercase;
      font-size: 12px;
      letter-spacing:.35px;
    }
    summary::-webkit-details-marker{ display:none; }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td{
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      text-align:left;
      vertical-align:middle;
    }
    th{
      color: var(--muted);
      font-size: 12px;
      text-transform:uppercase;
      letter-spacing:.25px;
      background: rgba(255,255,255,.03);
    }
    html[data-theme="light"] th{ background: rgba(0,0,0,.03); }

    tr.active{
      outline: 2px solid rgba(42,157,143,.35);
      outline-offset: -2px;
      background: rgba(42,157,143,.10);
    }

    .right{ text-align:right; }
    .mono{ font-family: var(--mono); }
    .small{ font-size: 12px; color: var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>Nozzle â†’ Bead Calculator</h1>
        <p>Two modes: pick a <strong>nozzle</strong> (classic) or start from a target <strong>bead width</strong> (designer mode). Updates live.</p>
      </div>

      <div class="rightHead">
        <button class="themeBtn" id="themeBtn" type="button" aria-label="Toggle light/dark theme">
          <span id="themeIcon" aria-hidden="true">ðŸŒ™</span>
          <span id="themeText">Light mode</span>
        </button>

        <div class="badge" title="Embeddable: host this file and iframe it anywhere">
          <span style="width:10px;height:10px;border-radius:999px;background:var(--accent2);display:inline-block"></span>
          Single-file â€¢ No dependencies â€¢ Responsive
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Controls -->
      <section class="card" aria-label="Controls">
        <div class="head">
          <h2>Inputs</h2>
          <div class="btns">
            <button id="copyBtn" class="std primary" type="button">Copy settings</button>
          </div>
        </div>

        <div class="body">
          <!-- Mode switch -->
          <div class="seg" role="tablist" aria-label="Input mode">
            <button id="modeNozzleBtn" class="active" type="button" role="tab" aria-selected="true">
              Pick nozzle
            </button>
            <button id="modeBeadBtn" type="button" role="tab" aria-selected="false">
              Pick bead width
            </button>
          </div>

          <!-- MODE A: NOZZLE -->
          <div id="nozzleMode">
            <div class="row">
              <div>
                <label for="nozzleSelect">Nozzle size (mm)</label>
                <select id="nozzleSelect"></select>
              </div>

              <div id="customNozzleBox" style="display:none">
                <label for="customNozzle">Custom nozzle (mm)</label>
                <input id="customNozzle" type="number" min="0.1" step="0.1" value="6" inputmode="decimal" />
              </div>
            </div>

            <div class="sliderWrap" aria-label="Nozzle slider">
              <label for="nozzleSlider" style="margin:0 0 8px">Quick select</label>
              <input id="nozzleSlider" type="range" min="0" max="8" step="1" value="2" />
              <div class="ticks" id="nozzleTicks"></div>
            </div>

            <div class="toggleLine">
              <label class="switch" for="useCustomNozzle">
                <input id="useCustomNozzle" type="checkbox" />
                <span class="pill" aria-hidden="true"><span class="dot"></span></span>
                Use custom nozzle size
              </label>

              <span class="small mono">Classic mode</span>
            </div>
          </div>

          <!-- MODE B: BEAD WIDTH -->
          <div id="beadMode" style="display:none">
            <div class="row">
              <div>
                <label for="beadWidthInput">Target bead width (mm)</label>
                <input id="beadWidthInput" type="number" min="0.1" step="0.1" value="9.4" inputmode="decimal" />
              </div>
              <div>
                <label for="beadSnapSelect">Quick targets</label>
                <select id="beadSnapSelect"></select>
              </div>
            </div>

            <div class="sliderWrap" aria-label="Bead width slider">
              <label for="beadSlider" style="margin:0 0 8px">Quick select</label>
              <input id="beadSlider" type="range" min="0" max="8" step="1" value="2" />
              <div class="ticks" id="beadTicks"></div>
            </div>

            <div class="toggleLine">
              <span class="small mono">Designer mode</span>
              <span class="small">We recommend nozzle + layer height from your dataset.</span>
            </div>
          </div>

          <!-- Advanced -->
          <div class="toggleLine" style="margin-top:14px">
            <label class="switch" for="showAdvanced">
              <input id="showAdvanced" type="checkbox" />
              <span class="pill" aria-hidden="true"><span class="dot"></span></span>
              Advanced inputs
            </label>
            <span class="small mono">Area always shown</span>
          </div>

          <div id="advancedPanel" style="display:none;margin-top:12px">
            <div class="row">
              <div>
                <label for="fillFactor">Effective area factor (default 0.78)</label>
                <input id="fillFactor" type="number" min="0" max="1" step="0.01" value="0.78" />
              </div>
              <div>
                <label for="rounding">Rounding (mm)</label>
                <input id="rounding" type="number" min="0" step="0.1" value="0.1" />
              </div>
            </div>

            <div class="note">
              Advanced inputs let you change the <strong>effective area factor</strong> (your sheet used 0.78) and rounding.
              Recommended values still come from your dataset (or interpolation).
            </div>
          </div>

          <div class="note" id="modeNote">
            Using your dataset values (exact matches for 2, 4, 6, 9, 12, 15, 18, 21, 24 mm).
          </div>
        </div>

        <details>
          <summary>
            Dataset table
            <span class="small">tap to expand</span>
          </summary>
          <div style="overflow:auto">
            <table aria-label="Dataset">
              <thead>
                <tr>
                  <th>Nozzle (mm)</th>
                  <th class="right">Area (mmÂ²)</th>
                  <th class="right">Eff @ factor (mmÂ²)</th>
                  <th class="right">Bead WÃ—H (mm)</th>
                  <th class="right">Ratio (w/h)</th>
                </tr>
              </thead>
              <tbody id="dataTable"></tbody>
            </table>
          </div>
        </details>
      </section>

      <!-- Results -->
      <section class="card" aria-label="Results">
        <div class="head">
          <h2>Recommended settings</h2>
          <div class="small mono" id="selectedLabel">Nozzle: 6.0 mm</div>
        </div>

        <div class="body">
          <div class="kpis">
            <div class="kpi">
              <div class="lab" id="widthLabel">Bead width (mm)</div>
              <div class="val" id="outWidth">â€”</div>
              <div class="sub" id="widthSub">Line width / bead width</div>
            </div>

            <div class="kpi">
              <div class="lab">Layer height (mm)</div>
              <div class="val" id="outHeight">â€”</div>
              <div class="sub">Bead height / layer height</div>
            </div>

            <div class="kpi">
              <div class="lab">Ratio (w/h)</div>
              <div class="val" id="outRatio">â€”</div>
              <div class="sub" id="outRatioSub">â€”</div>
            </div>

            <!-- Always visible -->
            <div class="kpi">
              <div class="lab">Nozzle area (mmÂ²)</div>
              <div class="val" id="outArea">â€”</div>
              <div class="sub" id="outEff">â€”</div>
            </div>
          </div>

          <div class="viz" aria-label="Bead visualisation">
            <div class="vizTop">
              <span>Visual (relative)</span>
              <span id="vizCaption">â€”</span>
            </div>
            <div class="stage">
              <div class="bed">
                <div class="bead" id="bead"></div>
              </div>
            </div>
            <div class="dim">
              <span id="dimW">W: â€”</span>
              <span id="dimH">H: â€”</span>
            </div>
          </div>

          <div class="note" id="hint">
            Tip: start with these values, then tune for material/temperature/flow stability. Keep the ratio close unless you have a reason to change it.
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // === Dataset from your sheet (Nozzle â†’ Ideal bead dimensions + ratio) ===
    const DATA = [
      { d: 2,  w: 2.7,  h: 0.9, ratioLabel: "3:1" },
      { d: 4,  w: 6.3,  h: 1.5, ratioLabel: "4:1" },
      { d: 6,  w: 9.4,  h: 2.4, ratioLabel: "4:1" },
      { d: 9,  w: 14.0, h: 3.5, ratioLabel: "4:1" },
      { d: 12, w: 21.0, h: 4.2, ratioLabel: "5:1" },
      { d: 15, w: 28.7, h: 4.8, ratioLabel: "6:1" },
      { d: 18, w: 34.5, h: 5.8, ratioLabel: "6:1" },
      { d: 21, w: 40.2, h: 6.7, ratioLabel: "6:1" },
      { d: 24, w: 46.0, h: 7.6, ratioLabel: "6:1" },
    ];

    // ===== DOM =====
    const nozzleMode = document.getElementById("nozzleMode");
    const beadMode = document.getElementById("beadMode");
    const modeNozzleBtn = document.getElementById("modeNozzleBtn");
    const modeBeadBtn = document.getElementById("modeBeadBtn");

    const nozzleSelect = document.getElementById("nozzleSelect");
    const nozzleSlider = document.getElementById("nozzleSlider");
    const nozzleTicks = document.getElementById("nozzleTicks");

    const useCustomNozzle = document.getElementById("useCustomNozzle");
    const customNozzleBox = document.getElementById("customNozzleBox");
    const customNozzle = document.getElementById("customNozzle");

    const beadWidthInput = document.getElementById("beadWidthInput");
    const beadSnapSelect = document.getElementById("beadSnapSelect");
    const beadSlider = document.getElementById("beadSlider");
    const beadTicks = document.getElementById("beadTicks");

    const showAdvanced = document.getElementById("showAdvanced");
    const advancedPanel = document.getElementById("advancedPanel");
    const fillFactor = document.getElementById("fillFactor");
    const rounding = document.getElementById("rounding");

    const selectedLabel = document.getElementById("selectedLabel");
    const modeNote = document.getElementById("modeNote");

    const widthLabel = document.getElementById("widthLabel");
    const widthSub = document.getElementById("widthSub");

    const outWidth = document.getElementById("outWidth");
    const outHeight = document.getElementById("outHeight");
    const outRatio = document.getElementById("outRatio");
    const outRatioSub = document.getElementById("outRatioSub");
    const outArea = document.getElementById("outArea");
    const outEff = document.getElementById("outEff");

    const dataTable = document.getElementById("dataTable");

    const bead = document.getElementById("bead");
    const vizCaption = document.getElementById("vizCaption");
    const dimW = document.getElementById("dimW");
    const dimH = document.getElementById("dimH");

    const copyBtn = document.getElementById("copyBtn");

    // Theme toggle
    const themeBtn = document.getElementById("themeBtn");
    const themeIcon = document.getElementById("themeIcon");
    const themeText = document.getElementById("themeText");

    // ===== State =====
    let inputMode = "nozzle"; // "nozzle" | "bead"

    // ===== Helpers =====
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const areaCircle = (d) => Math.PI * Math.pow(d/2, 2);

    function roundTo(x, step){
      const s = Math.max(0, Number(step) || 0);
      if (s === 0) return x;
      return Math.round(x / s) * s;
    }

    function format(x, decimals=1){
      const n = Number(x);
      if (!isFinite(n)) return "â€”";
      return n.toFixed(decimals);
    }

    function nearlyEqual(a,b,eps=1e-6){ return Math.abs(a-b) <= eps; }

    function buildNozzleSelect(){
      nozzleSelect.innerHTML = "";
      for (const p of DATA){
        const opt = document.createElement("option");
        opt.value = String(p.d);
        opt.textContent = `${p.d} mm`;
        nozzleSelect.appendChild(opt);
      }
      nozzleSelect.value = "6";
    }

    function buildBeadSelect(){
      beadSnapSelect.innerHTML = "";
      for (const p of DATA){
        const opt = document.createElement("option");
        opt.value = String(p.w);
        opt.textContent = `${p.w.toFixed(1)} mm (from ${p.d}mm nozzle)`;
        beadSnapSelect.appendChild(opt);
      }
      beadSnapSelect.value = "9.4";
    }

    function buildTicks(){
      nozzleTicks.innerHTML = "";
      beadTicks.innerHTML = "";

      for (const p of DATA){
        const s1 = document.createElement("span");
        s1.textContent = p.d;
        nozzleTicks.appendChild(s1);

        const s2 = document.createElement("span");
        s2.textContent = p.w.toFixed(1);
        beadTicks.appendChild(s2);
      }
    }

    function buildTable(){
      dataTable.innerHTML = "";
      const factor = clamp(Number(fillFactor.value) || 0.78, 0, 1);

      for (const p of DATA){
        const tr = document.createElement("tr");
        tr.dataset.d = String(p.d);

        const a = areaCircle(p.d);
        const eff = a * factor;

        tr.innerHTML = `
          <td class="mono">${p.d}</td>
          <td class="right mono">${format(a,2)}</td>
          <td class="right mono">${format(eff,2)}</td>
          <td class="right mono">${format(p.w,1)} Ã— ${format(p.h,1)}</td>
          <td class="right mono">${p.ratioLabel}</td>
        `;
        dataTable.appendChild(tr);
      }
    }

    function setActiveRowByNozzle(d){
      [...dataTable.querySelectorAll("tr")].forEach(tr => tr.classList.remove("active"));
      let nearest = DATA[0];
      for (const p of DATA){
        if (Math.abs(p.d - d) < Math.abs(nearest.d - d)) nearest = p;
      }
      const tr = dataTable.querySelector(`tr[data-d="${nearest.d}"]`);
      if (tr) tr.classList.add("active");
    }

    // ---- Mode A: interpolate by nozzle diameter (for custom nozzle) ----
    function interpolateByNozzle(d){
      if (d <= DATA[0].d) return { ...DATA[0], d, isExact: nearlyEqual(d, DATA[0].d), isInterpolated: !nearlyEqual(d, DATA[0].d), inRange:false, bracketD:[DATA[0].d, DATA[1].d] };
      if (d >= DATA[DATA.length-1].d) return { ...DATA[DATA.length-1], d, isExact: nearlyEqual(d, DATA[DATA.length-1].d), isInterpolated: !nearlyEqual(d, DATA[DATA.length-1].d), inRange:false, bracketD:[DATA[DATA.length-2].d, DATA[DATA.length-1].d] };

      for (let i=0;i<DATA.length;i++){
        if (nearlyEqual(d, DATA[i].d)) return { ...DATA[i], d: DATA[i].d, isExact:true, isInterpolated:false, inRange:true };
      }

      let i0=0,i1=1;
      for (let i=0;i<DATA.length-1;i++){
        if (d >= DATA[i].d && d <= DATA[i+1].d){ i0=i; i1=i+1; break; }
      }
      const p0=DATA[i0], p1=DATA[i1];
      const t=(d - p0.d)/(p1.d - p0.d);
      const w=p0.w + t*(p1.w - p0.w);
      const h=p0.h + t*(p1.h - p0.h);
      const ratioInt=Math.round(w/h);

      return {
        d, w, h,
        ratioLabel: `${ratioInt}:1`,
        isExact:false,
        isInterpolated:true,
        inRange:true,
        bracketD:[p0.d,p1.d]
      };
    }

    // ---- Mode B: interpolate by bead width (designer mode) ----
    function interpolateByWidth(targetW){
      // exact match?
      for (const p of DATA){
        if (nearlyEqual(targetW, p.w)) {
          return {
            d: p.d,
            w: p.w,
            h: p.h,
            ratioLabel: p.ratioLabel,
            isExact: true,
            isInterpolated: false,
            inRange: true,
            bracketW: [p.w, p.w],
            bracketD: [p.d, p.d],
          };
        }
      }

      const minW = DATA[0].w;
      const maxW = DATA[DATA.length-1].w;

      // choose segment for interpolation/extrapolation
      let i0=0, i1=1;
      if (targetW <= minW){
        i0=0; i1=1;
      } else if (targetW >= maxW){
        i0=DATA.length-2; i1=DATA.length-1;
      } else {
        for (let i=0;i<DATA.length-1;i++){
          if (targetW >= DATA[i].w && targetW <= DATA[i+1].w){
            i0=i; i1=i+1; break;
          }
        }
      }

      const p0=DATA[i0], p1=DATA[i1];
      const t=(targetW - p0.w)/(p1.w - p0.w);
      const d=p0.d + t*(p1.d - p0.d);
      const h=p0.h + t*(p1.h - p0.h);
      const ratioInt=Math.round(targetW/h);

      return {
        d,
        w: targetW,
        h,
        ratioLabel: `${ratioInt}:1`,
        isExact:false,
        isInterpolated:true,
        inRange: (targetW >= minW && targetW <= maxW),
        bracketW:[p0.w,p1.w],
        bracketD:[p0.d,p1.d],
      };
    }

    function updateSlidersForNozzlePreset(d){
      const idx = DATA.findIndex(x => x.d === d);
      if (idx >= 0) nozzleSlider.value = String(idx);
      nozzleSelect.value = String(d);
    }

    function updateBeadQuickControlsFromWidth(w){
      // set dropdown + slider to nearest dataset width (for convenience)
      let nearest = DATA[0];
      for (const p of DATA){
        if (Math.abs(p.w - w) < Math.abs(nearest.w - w)) nearest = p;
      }
      beadSnapSelect.value = String(nearest.w);
      beadSlider.value = String(DATA.findIndex(x => x.w === nearest.w));
    }

    function getCurrent(){
      const step = Math.max(0, Number(rounding.value) || 0);
      const factor = clamp(Number(fillFactor.value) || 0.78, 0, 1);

      if (inputMode === "nozzle"){
        if (!useCustomNozzle.checked){
          const d = Number(nozzleSelect.value);
          const p = DATA.find(x => x.d === d) || DATA[2];
          return { ...p, d: p.d, factor, step, mode:"nozzle", isExact:true, isInterpolated:false, inRange:true };
        }
        const d = Math.max(0.1, Number(customNozzle.value) || 6);
        const est = interpolateByNozzle(d);
        return { ...est, factor, step, mode:"nozzle" };
      }

      // bead width mode
      const targetW = Math.max(0.1, Number(beadWidthInput.value) || 9.4);
      const est = interpolateByWidth(targetW);
      return { ...est, factor, step, mode:"bead" };
    }

    function updateUI(){
      const cur = getCurrent();

      // rounding
      const w = roundTo(cur.w, cur.step);
      const h = roundTo(cur.h, cur.step);

      const ratio = (h > 0) ? (w / h) : NaN;
      const ratioActual = isFinite(ratio) ? ratio : NaN;

      // labels depending on mode
      if (cur.mode === "bead"){
        selectedLabel.textContent = `Recommended nozzle: ${format(cur.d,1)} mm`;
        widthLabel.textContent = "Target bead width (mm)";
        widthSub.textContent = "Your chosen width";
      } else {
        selectedLabel.textContent = `Nozzle: ${format(cur.d,1)} mm`;
        widthLabel.textContent = "Bead width (mm)";
        widthSub.textContent = "Line width / bead width";
      }

      outWidth.textContent = `${format(w,1)}`;
      outHeight.textContent = `${format(h,1)}`;

      const ratioLabel = cur.isExact ? cur.ratioLabel : `${Math.round(ratioActual)}:1`;
      outRatio.textContent = ratioLabel;

      const ratioLine = isFinite(ratioActual) ? `Actual: ${ratioActual.toFixed(2)} (w/h)` : "â€”";
      if (cur.isInterpolated){
        if (cur.mode === "bead"){
          outRatioSub.textContent = `Derived from width ${format(cur.bracketW?.[0] ?? 0,1)}â€“${format(cur.bracketW?.[1] ?? 0,1)} mm â€¢ ${ratioLine}`;
        } else {
          outRatioSub.textContent = `Interpolated between ${format(cur.bracketD?.[0] ?? 0,1)}â€“${format(cur.bracketD?.[1] ?? 0,1)} mm â€¢ ${ratioLine}`;
        }
      } else {
        outRatioSub.textContent = ratioLine;
      }

      // nozzle area (always)
      const A = areaCircle(cur.d);
      const Eff = A * cur.factor;
      outArea.textContent = `${format(A,2)}`;
      outEff.textContent = `Effective @ ${cur.factor.toFixed(2)}: ${format(Eff,2)} mmÂ²`;

      // mode note
      if (cur.mode === "nozzle"){
        if (!useCustomNozzle.checked){
          modeNote.innerHTML = `Nozzle mode: using <strong>exact dataset values</strong> (2, 4, 6, 9, 12, 15, 18, 21, 24 mm).`;
        } else {
          modeNote.innerHTML = cur.inRange
            ? `Nozzle mode: <strong>custom nozzle</strong> estimated by interpolation.`
            : `Nozzle mode: <strong>custom nozzle</strong> estimated by extrapolation (outside dataset range).`;
        }
      } else {
        modeNote.innerHTML = cur.inRange
          ? `Bead mode: recommending <strong>nozzle + layer height</strong> by interpolation from your dataset.`
          : `Bead mode: recommending <strong>nozzle + layer height</strong> by extrapolation (outside dataset range).`;
      }

      // visual bead sizing (relative scaling)
      const maxW = 360;
      const maxH = 110;
      const maxDataW = Math.max(...DATA.map(p => p.w));
      const maxDataH = Math.max(...DATA.map(p => p.h));

      const wPx = clamp((w / maxDataW) * maxW, 18, maxW);
      const hPx = clamp((h / maxDataH) * maxH, 10, maxH);

      bead.style.width = `${wPx}px`;
      bead.style.height = `${hPx}px`;
      bead.style.borderRadius = `${Math.max(10, Math.min(wPx, hPx) / 2)}px`;

      vizCaption.textContent = `${format(w,1)} Ã— ${format(h,1)} mm`;
      dimW.textContent = `W: ${format(w,1)} mm`;
      dimH.textContent = `H: ${format(h,1)} mm`;

      buildTable();
      setActiveRowByNozzle(cur.d);

      // keep bead-mode quick controls roughly in sync
      if (cur.mode === "bead"){
        updateBeadQuickControlsFromWidth(cur.w);
      }
    }

    // ======================
    // Theme toggle
    // ======================
    function getTheme(){
      return document.documentElement.getAttribute("data-theme") || "dark";
    }
    function setTheme(theme){
      if (theme === "light") {
        document.documentElement.setAttribute("data-theme", "light");
        themeIcon.textContent = "â˜€ï¸";
        themeText.textContent = "Dark mode";
      } else {
        document.documentElement.removeAttribute("data-theme");
        themeIcon.textContent = "ðŸŒ™";
        themeText.textContent = "Light mode";
      }
      localStorage.setItem("nozzle_calc_theme", theme);
    }
    function initTheme(){
      const saved = localStorage.getItem("nozzle_calc_theme");
      if (saved === "light" || saved === "dark") setTheme(saved);
      else setTheme("dark");
    }
    themeBtn.addEventListener("click", () => {
      const t = getTheme();
      setTheme(t === "light" ? "dark" : "light");
    });

    // ======================
    // Mode switching
    // ======================
    function setMode(mode){
      inputMode = mode;

      const isNozzle = mode === "nozzle";
      nozzleMode.style.display = isNozzle ? "" : "none";
      beadMode.style.display = isNozzle ? "none" : "";

      modeNozzleBtn.classList.toggle("active", isNozzle);
      modeBeadBtn.classList.toggle("active", !isNozzle);
      modeNozzleBtn.setAttribute("aria-selected", String(isNozzle));
      modeBeadBtn.setAttribute("aria-selected", String(!isNozzle));

      updateUI();
    }

    modeNozzleBtn.addEventListener("click", () => setMode("nozzle"));
    modeBeadBtn.addEventListener("click", () => setMode("bead"));

    // ======================
    // Events: Nozzle mode
    // ======================
    nozzleSlider.addEventListener("input", () => {
      if (inputMode !== "nozzle") return;
      if (useCustomNozzle.checked) return;
      const idx = Number(nozzleSlider.value);
      const d = DATA[clamp(idx,0,DATA.length-1)].d;
      nozzleSelect.value = String(d);
      updateUI();
    });

    nozzleSelect.addEventListener("change", () => {
      if (inputMode !== "nozzle") return;
      if (useCustomNozzle.checked) return;
      updateSlidersForNozzlePreset(Number(nozzleSelect.value));
      updateUI();
    });

    useCustomNozzle.addEventListener("change", () => {
      customNozzleBox.style.display = useCustomNozzle.checked ? "" : "none";
      if (!useCustomNozzle.checked){
        updateSlidersForNozzlePreset(Number(nozzleSelect.value));
      }
      updateUI();
    });

    customNozzle.addEventListener("input", () => {
      if (inputMode !== "nozzle") return;
      updateUI();
    });

    // ======================
    // Events: Bead mode
    // ======================
    beadSlider.addEventListener("input", () => {
      if (inputMode !== "bead") return;
      const idx = Number(beadSlider.value);
      const w = DATA[clamp(idx,0,DATA.length-1)].w;
      beadWidthInput.value = String(w);
      beadSnapSelect.value = String(w);
      updateUI();
    });

    beadSnapSelect.addEventListener("change", () => {
      if (inputMode !== "bead") return;
      const w = Number(beadSnapSelect.value);
      beadWidthInput.value = String(w);
      beadSlider.value = String(DATA.findIndex(x => x.w === w));
      updateUI();
    });

    beadWidthInput.addEventListener("input", () => {
      if (inputMode !== "bead") return;
      updateUI();
    });

    // ======================
    // Advanced
    // ======================
    showAdvanced.addEventListener("change", () => {
      advancedPanel.style.display = showAdvanced.checked ? "" : "none";
      updateUI();
    });
    fillFactor.addEventListener("input", updateUI);
    rounding.addEventListener("input", updateUI);

    // ======================
    // Copy
    // ======================
    copyBtn.addEventListener("click", async () => {
      const cur = getCurrent();
      const step = Math.max(0, Number(rounding.value) || 0);
      const w = roundTo(cur.w, step);
      const h = roundTo(cur.h, step);
      const ratio = (h > 0) ? (w/h) : NaN;
      const ratioLabel = cur.isExact ? cur.ratioLabel : `${Math.round(ratio)}:1`;

      const prefix = (cur.mode === "bead")
        ? `Mode: Bead width | Target width: ${format(w,1)} mm`
        : `Mode: Nozzle | Nozzle: ${format(cur.d,1)} mm`;

      const text =
        `${prefix} | Recommended nozzle: ${format(cur.d,1)} mm | Layer height: ${format(h,1)} mm | Ratio (w/h): ${ratioLabel} (actual ${ratio.toFixed(2)})`;

      try{
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = "Copied!";
        setTimeout(()=> copyBtn.textContent = "Copy settings", 900);
      } catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        copyBtn.textContent = "Copied!";
        setTimeout(()=> copyBtn.textContent = "Copy settings", 900);
      }
    });

    // ======================
    // Init
    // ======================
    function init(){
      initTheme();

      buildNozzleSelect();
      buildBeadSelect();
      buildTicks();

      nozzleSlider.min = "0";
      nozzleSlider.max = String(DATA.length - 1);
      nozzleSlider.value = "2"; // 6mm

      beadSlider.min = "0";
      beadSlider.max = String(DATA.length - 1);
      beadSlider.value = "2"; // 9.4mm

      beadWidthInput.value = "9.4";

      updateSlidersForNozzlePreset(6);
      setMode("nozzle"); // default mode
      updateUI();
    }

    init();
  </script>
</body>
</html>
